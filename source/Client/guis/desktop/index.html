<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
	"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="de" lang="de">
<head>
	<meta http-equiv="content-type" content="text/html; charset=UTF-8">

	<title>Webarena 1.0</title>
	
	<meta content="minimum-scale=1.0, initial-scale=1.0, width=device-width, maximum-scale=1, user-scalable=no" name="viewport" />
	<meta content="yes" name="apple-mobile-web-app-capable" />
	<link rel="apple-touch-icon" sizes="72x72" href="/guis.common/images/ipad_icon.png" />

	<link href='http://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet' type='text/css'>

	<script src="/socket.io/socket.io.js"></script>

	<script src="/config.default.js"></script>
	<script src="/config.local.js"></script>
	<script src="/Helper.js"></script>
	<script src="/Dispatcher.js"></script>
	<script src="/ObjectManager.js"></script>
	<script src="/SocketClient.js"></script>

	<script src="/Common/Log.js"></script>
	<script src="/Common/DataSet.js"></script>
	<script src="/Common/ActionManager.js"></script>
	<script src="/Common/AttributeManager.js"></script>
	<script src="/Common/TranslationManager.js"></script>

	<script>
	var  Modules={
		'Log':Log,
		'config':Config,
		'Config':Config,
		'SocketClient':SocketClient,
		'Dispatcher':Dispatcher,
		'ObjectManager':ObjectManager,
		'Helper':Helper,

		//Object specific

		'DataSet':DataSet,
		'AttributeManager':AttributeManager,
		'TranslationManager':TranslationManager,
		'ActionManager':ActionManager,
	};

	for (var name in Modules){
		var module=Modules[name];
		if (module.init) {
			console.log('Initializing '+name);
			module.init(Modules);
			module.Modules=Modules;
		}
	}

	</script>

	<script src="/objects"></script>
	

	<script type="text/javascript" src="/guis.common/libraries/jquery/jquery.js"></script>
	<script type="text/javascript" src="/guis.common/libraries/jquery/plugins/jquery.jPopover.js"></script>
    <script type="text/javascript" src="/guis.common/libraries/jsTree/jquery.jstree.js"></script>
    <script type="text/javascript" src="/guis.common/libraries/moment.min.js"></script>
    <script type="text/javascript" src="/guis.common/libraries/underscore-min.js"></script>
    <script type="text/javascript" src="/guis.common/libraries/jquery/plugins/jquery.autogrow.js"></script>
    <script type="text/javascript" src="/guis.common/libraries/jquery/plugins/jquery.jeditable.js"></script>
    <script type="text/javascript" src="/guis.common/libraries/jquery/plugins/jquery.jeditable.autogrow.js"></script>
    <script type="text/javascript" src="/guis.common/libraries/jquery/plugins/jquery.dotdotdot.js"></script>



	<script type="text/javascript" src="/guis.common/libraries/jquery/plugins/jquery.svg.min.js"></script>
	<script type="text/javascript" src="/guis.common/libraries/jquery/plugins/jquery.svgdom.min.js"></script>
	<script type="text/javascript" src="/guis.common/libraries/jquery/plugins/jquery.svgfilter.min.js"></script>
	<script type="text/javascript" src="/guis.common/libraries/jquery/plugins/jquery.svganim.min.js"></script>

	<script type="text/javascript" src="/guis.common/libraries/jquery/jquery-ui.js"></script>
	<link type="text/css" href="/guis.common/libraries/jquery/css/jquery-ui.css" rel="Stylesheet" />

	<script type="text/javascript" src="/guis.common/libraries/jquery/plugins/jquery.color.js"></script>

	<link type="text/css" href="/guis/desktop/style.css" rel="Stylesheet" />


	<script type="text/javascript" src="/guis.common/javascript/0.GUI.js"></script>
	<script type="text/javascript" src="/guis.common/javascript/0.cookies.js"></script>
    <script type="text/javascript" src="/guis.common/javascript/0.string.js"></script>
	<script type="text/javascript" src="/guis.common/javascript/1.progressBarManager.js"></script>
	<script type="text/javascript" src="/guis.common/javascript/1.login.js"></script>
	<script type="text/javascript" src="/guis.common/javascript/1.load.js"></script>
	<script type="text/javascript" src="/guis.common/javascript/1.actionsheet.js"></script>
	<script type="text/javascript" src="/guis.common/javascript/1.inspector.js"></script>
	<script type="text/javascript" src="/guis.common/javascript/1.links.js"></script>
	<script type="text/javascript" src="/guis.common/javascript/1.paint.js"></script>
	<script type="text/javascript" src="/guis.common/javascript/1.rubberband.js"></script>
	<script type="text/javascript" src="/guis.common/javascript/1.svg.js"></script>
	<script type="text/javascript" src="/guis.common/javascript/1.text.js"></script>
	<script type="text/javascript" src="/guis.common/javascript/1.toolbar.js"></script>
	<script type="text/javascript" src="/guis.common/javascript/1.dragDropUpload.js"></script>
	<script type="text/javascript" src="/guis.common/javascript/1.chat.js"></script>
	<script type="text/javascript" src="/guis.common/javascript/1.userMarker.js"></script>

	<script type="text/javascript" src="/guis.common/translation_de.js"></script>
	
	<link type="text/css" href="/guis.common/css/actionsheet.css" rel="Stylesheet" />
	<link type="text/css" href="/guis.common/css/progressBar.css" rel="Stylesheet" />
	<link type="text/css" href="/guis.common/css/login.css" rel="Stylesheet" />
	<link type="text/css" href="/guis.common/css/discussion.css" rel="Stylesheet" />
    <link type="text/css" href="/guis.common/css/easydb.css" rel="Stylesheet" />
    <link type="text/css" href="/guis.common/css/sharepoint.css" rel="Stylesheet" />
	



	<script type="text/javascript" src="/guis.common/libraries/jquery/plugins/jquery.jDesktopInspector.js"></script>
	<link type="text/css" href="/guis.common/libraries/jquery/plugins/css/jquery.jDesktopInspector.css" rel="Stylesheet" />
	<link type="text/css" href="/guis.common/libraries/jquery/plugins/css/jquery.jPopover.desktop.css" rel="Stylesheet" />
	
	<script>
	
		/**
		 * check if device is touch-device
		 */
		if (!!('ontouchstart' in window)) {
			GUI.isTouchDevice = true;
		}
		
		
		
		/**
		 * GUI specific file upload method
		 * @param {webarenaObject} object The webarena object to upload the file
		 * @param {String} message A message displayed when selecting the file
		 */
		GUI.uploadFile=function(object,message){
		
			var uploadDialog = document.createElement("div");
			$(uploadDialog).attr("title", GUI.translate("Upload file"));
			$(uploadDialog).html('<p>'+message+'</p>');
			
			var form = document.createElement("input");
			$(form).attr("type", "file");
			
			$(form).bind("change", function() {
			
				var progress = document.createElement("div");
				$(progress).css("margin-top", "10px");
				$(progress).progressbar({
					value: 0
				});

				$(uploadDialog).append(progress);

				var fd = new FormData();
				fd.append("file", form.files[0]);

				
				var filename = $(this).val().replace("C:\\fakepath\\", "");
				object.setAttribute('name', filename, true);
              

				var xhr = new XMLHttpRequest();
				xhr.upload.addEventListener("progress", function(evt) {
					
					if (evt.lengthComputable) {
						var percentComplete = Math.round(evt.loaded * 100 / evt.total);
						$(progress).progressbar("value", percentComplete);
					} else {
						$(progress).progressbar("destroy");
						$(progress).html("unable to compute progress");
					}
					
				}, false);
				
				xhr.addEventListener("load", function() {
					//upload complete
					$(uploadDialog).dialog("close");
				}, false);
				xhr.addEventListener("error", function() {
					//failed
					alert("failed");
				}, false);
				xhr.addEventListener("abort", function() {
					//canceled
					alert("cancel");
				}, false);
				xhr.open("POST", "/setContent/"+object.getCurrentRoom()+"/"+object.getAttribute('id')+"/"+ObjectManager.userHash);
				xhr.send(fd);
				
				var dialogButtons = {};
				dialogButtons[GUI.translate("cancel")] = function() {
					xhr.abort();
					$(this).dialog("close");
				}
				
				$(uploadDialog).dialog("option", "buttons", dialogButtons);
				
			});
			
			$(uploadDialog).append(form);
			
			var dialogButtons = {};
			dialogButtons[GUI.translate("cancel")] = function() {
				$(this).dialog("close");
			}
			
			$(uploadDialog).dialog({
				modal: true,
				resizable: false,
				buttons: dialogButtons
			});
			
		}
		
		
		/**
		 * GUI specific display of errors
		 * @param {String} heading A title for the upload dialog
		 * @param {String} message A message including the errors message
		 * @param {webarenaObject} [webarenaObject] An optional webarena object the error is related to
		 * @param {bool} fatal True if the error is fatal and the webpage has to be reloaded after displaying the error
		 */
		GUI.error = function(heading, message, webarenaObject, fatal) {

			var translate = function(text) {
				if (!webarenaObject) {
					return GUI.translate(text);
				} else {
					return webarenaObject.translate(GUI.currentLanguage, text);
				}
			}		

			var errorButtons = {};
			
			if (fatal) {
				errorButtons[GUI.translate("Reload")] = function() {
					window.location.reload();
				}
			} else {
				errorButtons[GUI.translate("Close Dialog")] = function() {
					$(this).dialog("close");
				}
			}
			
			var heading = translate(heading);
			var message = '<p>'+translate(message)+'</p>';
			
			GUI.dialog(heading, message, errorButtons);

		}
		
		
		/**
		 * GUI specific display of general messages (and complex control dialogs)
		 * @param {String} heading A title for the dialog
		 * @param {String|DOMObject} content A message or DOM object that will be used as the body of the dialog
		 * @param {Object} [buttons] The Buttons of the dialog (e.g. close, save, ...)
		 * @param {int} [dialogWidth=auto] The width of the dialog
		 * @param {bool} [passThrough] Additional options for the dialog
		 * @returns {jQueryDialogObject} The created jQuery dialog object
		 * 
		 * Form of buttons param:
		 * 
		 * {
		 * 		"title of this button" : function() {
		 * 			//button callback
		 * 		},
		 * 		...
		 * }
		 * 			
		 */
		GUI.dialog = function(heading, content, buttons, dialogWidth, passThrough) {
			
			GUI.blockKeyEvents = true;
			
			if (buttons == undefined) {
				
				var buttons = {};
				
				buttons[GUI.translate("close")] = function() {
					//nothing
				}
				
			}
			
			var dialogContent = document.createElement("div");
			$(dialogContent).attr("title", heading);
			$(dialogContent).append(content);

			var buttons2 = {};
			
			$.each(buttons, function(title, callback) {
				
				buttons2[title] = function() {
					callback(dialogContent);
					$(this).dialog("close");
				}
				
			});
			
			if (dialogWidth == undefined) {
				dialogWidth = "auto";
			}

            var dialogOptions = {
                modal: true,
                resizable: false,
                buttons: buttons2,
                zIndex: 100000,
                width : dialogWidth,
                close: function() {
                    $(this).remove();
                    GUI.blockKeyEvents = false;
                }
            }

            if(typeof passThrough === "object"){
                $.extend(dialogOptions, passThrough)
            }

			
			return $(dialogContent).dialog(dialogOptions);
			
			
		};
		
		
		
		
		/**
		 * @namespace Holding methods and variables for displaying a sidebar
		 */
		GUI.sidebar = {};
		
		/**
		 * True if the sidebar is shown
		 */
		GUI.sidebar.open = false;
		
		/**
		 * Currently shown element
		 */
		GUI.sidebar.currentElement = undefined;
		
		/**
		 * A saved state of the sidebar
		 */
		GUI.sidebar.savedState = undefined;
		
		/**
		 * Available sidebar pages
		 */
		GUI.sidebar.elementConfig = {
			"inspector" : {
				order : 0,
				title : GUI.translate("Object inspector"),
			},
			"chat" : {
				order : 1,
				title : GUI.translate("Chat"),
				onOpen : GUI.chat.opened
			},
			"bug" : {
				order : 2,
				title : GUI.translate("Bugreport"),
			},
		};
		
		/**
		 * move (scroll) sidebar to x position
		 * @param {DomElement} target The targets DOM element
		 * @param {int} x The x position to move the sidebar to
		 */
		GUI.sidebar.transformX = function(target, x) {
			
			var trans = "translate3d("+x+"px,0,0)";

			target.css("-webkit-transform", trans);
			target.css("-moz-transform", trans);
			target.css("-o-transform", trans);
			
		}

		/**
		 * open a sidebar page
		 * @param {String} element The name of the page to open (see GUI.sidebar.elementConfig)
		 * @param {DomElement} [button] The button which triggered the opening 
		 */
		GUI.sidebar.openPage = function(element, button) {
			
			/* check if the given element name exists */
			if (GUI.sidebar.elementConfig[element] == undefined) {
				console.error("Open Sidebar: Unknown element ID");
				return;
			}
			
			/* check if the page is already open */
			if (GUI.sidebar.currentElement == element && GUI.sidebar.open) {
				GUI.sidebar.closeSidebar();
				return;
			}
			
			/* set currently opened element/page */
			GUI.sidebar.currentElement = element;

			var left = GUI.sidebar.elementConfig[element]['order']*$("#sidebar").width()*(-1);

			/* check if sidebar is shown */
			if (!GUI.sidebar.open) {
				/* disable page flip animation and open sidebar (prevent multiple animations at once) */
				
				//disable animation for the next 500ms
				$("#sidebar_content>div").removeClass("animate");

				window.setTimeout(function() {
					$("#sidebar_content>div").addClass("animate");
				}, 500);
				
				GUI.sidebar.openSidebar();
				
			}
			
			GUI.sidebar.transformX($("#sidebar_content").children("div"), left);
			
			
			$("#sidebar_title").children("span").html(GUI.sidebar.elementConfig[element]['title']);
			
			$(".sidebar_button").removeClass("active");
			
			if (GUI.sidebar.elementConfig[element]['onOpen'] !== undefined) {
				GUI.sidebar.elementConfig[element]['onOpen']();
			}
			
			
			if (button !== undefined) {
				GUI.sidebar.elementConfig[element]['button'] = button;
			}

			if (GUI.sidebar.elementConfig[element]['button'] !== undefined) {
				$(GUI.sidebar.elementConfig[element]['button']).addClass("active");
			}

			$("#sidebar_content").scrollTop(0);
			
		}
		
		/**
		 * open the sidebar using animation
		 */
		GUI.sidebar.openSidebar = function() {
			
			GUI.sidebar.transformX($("#sidebar"), 0);
			GUI.sidebar.transformX($("#header>.header_right"), -230);
			
			GUI.sidebar.open = true;
			
		}
		
		/**
		 * close the sidebar
		 * @param {bool} noReset True if the current element should not be reset (used by GUI.sidebar.saveStateAndHide)
		 */
		GUI.sidebar.closeSidebar = function(noReset) {
			
			GUI.sidebar.transformX($("#sidebar"), 230);
			GUI.sidebar.transformX($("#header>.header_right"), 0);
			
			GUI.sidebar.open = false;
			
			if (noReset !== true) {
				GUI.sidebar.currentElement = undefined;
			}
			
			$(".sidebar_button").removeClass("active");
			
		}
		
		/**
		 * saves the current sidebar state and hides it
		 */
		GUI.sidebar.saveStateAndHide = function() {
			
			GUI.sidebar.savedState = {
				"open" : GUI.sidebar.open,
				"currentElement" : GUI.sidebar.currentElement
			};
			
			GUI.sidebar.closeSidebar(true);
			
		}
		
		/**
		 * restores the sidebar from the saved state and shows it
		 */
		GUI.sidebar.restoreFromSavedState = function() {

			if (GUI.sidebar.savedState.open) {
				
				GUI.sidebar.openSidebar();
				
				if (GUI.sidebar.elementConfig[GUI.sidebar.savedState.currentElement]['button'] !== undefined) {
					$(GUI.sidebar.elementConfig[GUI.sidebar.savedState.currentElement]['button']).addClass("active");
				}
				
			}
			
		}
		
		
		/**
		 * jQuery extension used to prevent scrolling of sidebar/body when scrolling of sidebar contents hits top/bottom (e.g. for chat messages container)
		 */
		$.fn.dontScrollParent = function()
		{
		    this.bind('mousewheel DOMMouseScroll',function(e)
		    {
		        var delta = e.originalEvent.wheelDelta || -e.originalEvent.detail;

		        if (delta > 0 && $(this).scrollTop() <= 0)
		            return false;
		        if (delta < 0 && $(this).scrollTop() >= this.scrollHeight - $(this).height())
		            return false;

		        return true;
		    });
		}
		
		/**
		 * init. the sidebar
		 */
		GUI.sidebar.init = function() {
			$("#sidebar_content>div").addClass("animate");
			$("#sidebar_content").dontScrollParent();
		}

		
		
		
		/**
		 * GUI specific inspector update
		 */
		GUI.updateInspector = function() {
			
			$("#inspector").data("jDesktopInspector").update();
			$("#sidebar_content").scrollTop(0);
			
		}
			
		/**
		 * GUI specific setup of inspector
		 */
		GUI.setupInspector = function() {
			
			/* add jQuery inspector plugin to inspector-div */
			$("#inspector").jDesktopInspector({
				onUpdate : function(domEl, inspector) {

					GUI.setupInspectorContent(inspector);

				}
			});
			
		}
		
		/**
		 * Set translated placeholder for username input at login screen
		 */
		$(function() {
			$("#login_username").attr("placeholder", GUI.translate("Username"));
		});

		/**
		 * Define room which will be loaded (value will be replaced by node.js Webserver)
		 */
		GUI.startRoom = '##START_ROOM##';
	

	
	
		/**
		 * Reporting of bugs
		 */
		$(function() {
		
			$("#bug_submit").bind("click", function(event) {
			
				$("#bug_report").hide();
				$("#bug_result").show();
				$("#bug_result").html('Der Fehlerbericht wird gesendet...');
			
				var task = $("#bug_task").val();
				var problem = $("#bug_problem").val();
				
				var objectsString = "";
				
				var objects = ObjectManager.getObjects();
				for (var i in objects) {
					var object = objects[i];
					
					objectsString += "\n"+i+":\n--------------------\n";
					
					var data=object.get();
					console.log(data);
					for (var name in data) {
						objectsString += name+": "+data[name]+"\n";
					}
					
				}
				
				ObjectManager.reportBug({
					"task" : task,
					"problem" : problem,
					"user" : GUI.username,
					"objects" : objectsString,
					"userAgent" : navigator.userAgent
				}, function(result) {

					if (result === true) {
						$("#bug_result").html('<p class="bug_success">Vielen Dank für Ihren Fehlerbericht.<br />Unsere Entwickler wurden informiert und werden sich schnellst möglich um das Problem kümmern.</p>');
						$("#bug_task").val("");
						$("#bug_problem").val("");
					} else {
						$("#bug_result").html('<p class="bug_error">Leider konnte der Fehlerbericht nicht gesendet werden. Bitte versuchen Sie es später noch einmal.</p>');
					}
					
					window.setTimeout(function() {
						$("#bug_report").show();
						$("#bug_result").hide();
					}, 10000);
					
				});
				
			});
			
		});
		
		/**
		 * Used to play a "huu" sound in chat ;)
		 */
		GUI.huu = function() {
			
			var huu = new Audio("");
			$("body").append(huu);
			
			huu.src = "/guis/desktop/huu.m4a";
			huu.play();
			
			window.setTimeout(function() {
				$(huu).remove();
			}, 4000);
			
		}
	
	</script>
</head>
<body>
	
	<div id="header">
		
		<div class="header_right">
			
		</div>
		
		<div class="header_left">
		
		</div>
		
	</div>


	<div id="content"></div>
	
	<div id="sidebar">
		<div id="sidebar_title"><span></span></div>
		<div id="sidebar_content">
			<div>
				<div id="inspector"></div>
				<div id="chat"></div>
				<div id="bug">
					
					<div>
						Ist Ihnen bei der Benutzung ein Fehler aufgefallen? Teilen Sie uns ihn doch bitte mit.<br />
						Bitte haben Sie Verständnis dafür, dass wir nicht auf jede Anfrage persönlich antworten können.
						<span><br />
						<br />
							Beachten Sie: Mit Ihrer Fehlermeldung wird eine Liste aller Objekte gesendet, um uns eine Auswertung des Fehlers zu ermöglichen.
						</span>
					</div>
					
					<div id="bug_report">
						
						<span>Was wollten Sie tun?</span>
						<textarea id="bug_task"></textarea>
					
						<span>Welches Problem ist aufgetreten?</span>
						<textarea id="bug_problem"></textarea>
					
						<input type="submit" value="Senden" id="bug_submit" />
					
					</div>
					
					<div id="bug_result"></div>
					
				</div>
			</div>
		</div>
	</div>
	
	<div id="actionsheet"></div>
	
	<div id="error_bg"></div>
	<div id="error_box">
		
		<div id="error_box_heading"></div>
		<div id="error_box_message"></div>
		<div id="error_box_button"></div>
		
	</div>


	<div id="login_background" style="display: none">&nbsp;</div>
	<div id="login" style="display: none;">
		
		<div class="login_title" id="login_title">Webarena 1.0</div>
		
		<div class="login_error"></div>
		
		<div class="login_icon login_icon_username"></div><input type="text" name="username" value="" id="login_username" class="login_input" autocomplete="off" placeholder="Username" autofocus="autofocus" />
		
		<br />
		
		<div class="login_icon login_icon_password"></div><input type="password" name="password" value="" id="login_password" class="login_input" autocomplete="off" />
		
		<br />
		
		<input type="submit" name="login" value="Login" class="login_submit" id="login_submit" />
		
	</div>
	
	
	<div id="progressBar"><div class="progressBar_container"></div></div>

</body>
</html>
